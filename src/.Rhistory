as_tibble() |>
mutate(chain = rep(c(1:3), 9000)) |>
mutate(index = seq(1:27000)) |>
pivot_wider(data = value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = rep(c(1:3), 9000)) |>
mutate(index = seq(1:27000))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = rep(c(1:3), 9000)) |>
mutate(index = seq(1:27000)) |>
pivot_wider(value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
# mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000)))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
# mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain) |>
select(c(index, "`1`"))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain) |>
select(c(index, `1`))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain) |>
select(c(index, `1`)) |>
drop_na()
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000))) |>
mutate(index = seq(1:27000)) |>
pivot_wider(values_from = value, names_from = chain) |>
select(c(index, `1`)) |>
drop_na() |>
ggplot(aes(x=index, y= `1`)) +
geom_line()
#Traza de la cadena
traceplot(covid.sim)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(rep(c(1:3), 9000)))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(c(rep(1, 9000), rep(2, 9000), rep(3, 9000))))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(c(rep(1, 9000), rep(2, 9000), rep(3, 9000)))) |>
mutate(index = seq(1:27000))
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(c(rep(1, 9000), rep(2, 9000), rep(3, 9000)))) |>
mutate(index = seq(1:27000)) |>
filter(index < 9001)
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(c(rep(1, 9000), rep(2, 9000), rep(3, 9000)))) |>
mutate(index = seq(1:27000)) |>
filter(index < 9001) |>
ggplot(aes(x=index, y= value)) +
geom_line()
covid.sim$sims.list["phi"][[1]][,6] |>
as_tibble() |>
mutate(chain = as.character(c(rep(1, 9000), rep(2, 9000), rep(3, 9000)))) |>
mutate(index = seq(1:27000)) |>
filter(index < 9001) |>
ggplot(aes(x=index, y= value)) +
geom_line()
#Cadena y resumen
{
out <- covid.sim$sims.list
out.sum <- covid.sim$summary
}
#DIC
{
out.dic<-covid.sim$DIC
print(out.dic)
}
#Beta
{
z<-out$beta[,2]
png(paste0("../results/", model_id, "/beta_2_summary.png"))
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
dev.off()
}
#Tabla resumen
{
out.b <- out.sum[grep("beta",rownames(out.sum)),c(1,3,7)]
out.b <- cbind(out.b,apply(out$beta,2,prob))
dimnames(out.b)[[2]][4] <- "prob"
print(out.b)
sink(paste0("../results/", model_id, "/beta_summary.txt"))
print(out.b)
sink()
}
#Predictions
{
out.yf <- out.sum[grep("yf",rownames(out.sum)),]
or <- order(y)
ymin <- min(y, out.yf[,c(1,3,7)])
ymax <- max(y, out.yf[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/predictions.png"))
par(mfrow=c(1,1))
plot(y[or],ylim=c(ymin,ymax), xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
lines(out.yf[or,1],lwd=2,col=2)
lines(out.yf[or,3],lty=2,col=2)
lines(out.yf[or,7],lty=2,col=2)
dev.off()
}
#R^2
{
png(paste0("../results/", model_id, "/r2.png"))
par(mfrow=c(1,1))
plot(y,out.yf[,1], ylab="Predicted y")
text(y,out.yf[,1], covid$Country)
abline(a=0, b=1)
dev.off()
R2<-(cor(y,out.yf[,1]))^2
print(R2)
}
#phi
{
out.phi<-out.sum[grep("phi",rownames(out.sum)),]
out.est<-out.phi
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/phi.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or], ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto espacial")
dev.off()
}
#theta
{
out.the<-out.sum[grep("the",rownames(out.sum)),]
out.est<-out.the
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/theta.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or],ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto individual")
dev.off()
}
#Map of lambda
{
out.lam<-out.sum[grep("lam",rownames(out.sum)),]
plotvar<-out.lam[,1]
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
png(paste0("../results/", model_id, "/predicted_smr.png"))
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
dev.off()
}
{
plotvar <- y / ee
plotvar <- ifelse(plotvar == Inf, 0, plotvar)
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
}
rho_weight <- 80 # Elegir del 0 al 100
data_proper <- list("n" = n, "y" = y, "ee" = ee, "x" = x,
"adj" = adj, "num" = m, "mu_areas" = mu_areas,
"C"=C, "M"=M, "gamma"=rho)
covid.sim_proper <- bugs(data_proper, inits, parameters, model.file = "covid_car_proper.txt",
n.iter = 10000, n.chains = 3, n.burnin = 1000, n.thin = 1,
debug = T)
model_id <- "car_propio_rho_80"
### Modelo CAR Propio
{
covid.sim <- covid.sim_proper
save_definition(model_id, data_proper, inits, parameters, covid.sim)
}
#Cadena y resumen
{
out <- covid.sim$sims.list
out.sum <- covid.sim$summary
}
#DIC
{
out.dic<-covid.sim$DIC
print(out.dic)
}
#Beta
{
z<-out$beta[,2]
png(paste0("../results/", model_id, "/beta_2_summary.png"))
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
dev.off()
}
#Tabla resumen
{
out.b <- out.sum[grep("beta",rownames(out.sum)),c(1,3,7)]
out.b <- cbind(out.b,apply(out$beta,2,prob))
dimnames(out.b)[[2]][4] <- "prob"
print(out.b)
sink(paste0("../results/", model_id, "/beta_summary.txt"))
print(out.b)
sink()
}
#Predictions
{
out.yf <- out.sum[grep("yf",rownames(out.sum)),]
or <- order(y)
ymin <- min(y, out.yf[,c(1,3,7)])
ymax <- max(y, out.yf[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/predictions.png"))
par(mfrow=c(1,1))
plot(y[or],ylim=c(ymin,ymax), xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
lines(out.yf[or,1],lwd=2,col=2)
lines(out.yf[or,3],lty=2,col=2)
lines(out.yf[or,7],lty=2,col=2)
dev.off()
}
#R^2
{
png(paste0("../results/", model_id, "/r2.png"))
par(mfrow=c(1,1))
plot(y,out.yf[,1], ylab="Predicted y")
text(y,out.yf[,1], covid$Country)
abline(a=0, b=1)
dev.off()
R2<-(cor(y,out.yf[,1]))^2
print(R2)
}
#phi
{
out.phi<-out.sum[grep("phi",rownames(out.sum)),]
out.est<-out.phi
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/phi.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or], ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto espacial")
dev.off()
}
#theta
{
out.the<-out.sum[grep("the",rownames(out.sum)),]
out.est<-out.the
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/theta.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or],ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto individual")
dev.off()
}
#Map of lambda
{
out.lam<-out.sum[grep("lam",rownames(out.sum)),]
plotvar<-out.lam[,1]
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
png(paste0("../results/", model_id, "/predicted_smr.png"))
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
dev.off()
}
{
plotvar <- y / ee
plotvar <- ifelse(plotvar == Inf, 0, plotvar)
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
}
rho
rho_weight <- 80 # Elegir del 0 al 100
rho <- (rho_weight/100) * (1 / max_eigen) + ((100-rho_weight)/100) * (1 / min_eigen)
rho
data_proper <- list("n" = n, "y" = y, "ee" = ee, "x" = x,
"adj" = adj, "num" = m, "mu_areas" = mu_areas,
"C"=C, "M"=M, "gamma"=rho)
covid.sim_proper <- bugs(data_proper, inits, parameters, model.file = "covid_car_proper.txt",
n.iter = 10000, n.chains = 3, n.burnin = 1000, n.thin = 1,
debug = T)
model_id <- "car_propio_rho_80"
### Modelo CAR Propio
{
covid.sim <- covid.sim_proper
save_definition(model_id, data_proper, inits, parameters, covid.sim)
}
#Cadena y resumen
{
out <- covid.sim$sims.list
out.sum <- covid.sim$summary
}
#DIC
{
out.dic<-covid.sim$DIC
print(out.dic)
}
#Beta
{
z<-out$beta[,2]
png(paste0("../results/", model_id, "/beta_2_summary.png"))
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
dev.off()
}
#Tabla resumen
{
out.b <- out.sum[grep("beta",rownames(out.sum)),c(1,3,7)]
out.b <- cbind(out.b,apply(out$beta,2,prob))
dimnames(out.b)[[2]][4] <- "prob"
print(out.b)
sink(paste0("../results/", model_id, "/beta_summary.txt"))
print(out.b)
sink()
}
#Predictions
{
out.yf <- out.sum[grep("yf",rownames(out.sum)),]
or <- order(y)
ymin <- min(y, out.yf[,c(1,3,7)])
ymax <- max(y, out.yf[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/predictions.png"))
par(mfrow=c(1,1))
plot(y[or],ylim=c(ymin,ymax), xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
lines(out.yf[or,1],lwd=2,col=2)
lines(out.yf[or,3],lty=2,col=2)
lines(out.yf[or,7],lty=2,col=2)
dev.off()
}
#R^2
{
png(paste0("../results/", model_id, "/r2.png"))
par(mfrow=c(1,1))
plot(y,out.yf[,1], ylab="Predicted y")
text(y,out.yf[,1], covid$Country)
abline(a=0, b=1)
dev.off()
R2<-(cor(y,out.yf[,1]))^2
print(R2)
}
#phi
{
out.phi<-out.sum[grep("phi",rownames(out.sum)),]
out.est<-out.phi
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/phi.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or], ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto espacial")
dev.off()
}
#theta
{
out.the<-out.sum[grep("the",rownames(out.sum)),]
out.est<-out.the
k<-n
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
}
{
png(paste0("../results/", model_id, "/theta.png"))
par(mfrow=c(1,1))
plot(1:k,out.est[,1][or],ylab="",ylim=c(ymin,ymax),
xlab="", xaxt='n')
axis(1, at=1:n, labels=covid$Country[or], las=2)
segments(1:k,out.est[,3][or],1:k,out.est[,7][or])
abline(h=0,col="grey70")
title("Efecto individual")
dev.off()
}
#Map of lambda
{
out.lam<-out.sum[grep("lam",rownames(out.sum)),]
plotvar<-out.lam[,1]
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
png(paste0("../results/", model_id, "/predicted_smr.png"))
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
dev.off()
}
{
plotvar <- y / ee
plotvar <- ifelse(plotvar == Inf, 0, plotvar)
plotclr <- brewer.pal(nclr,"YlOrBr")
class <- classIntervals(plotvar, nclr, dataPrecision=2,style="quantile")
colcode <- findColours(class,plotclr)
covid.map <- sps
plot(covid.map, col = colcode)
legend(x_etiquetas, y_etiquetas, legend = names(attr(colcode, "table")),
fill = attr(colcode, "palette"), cex=1, bty="n")
title(main="SMR")
}
inits_normal_normal <- function(){list(beta = rep(0,2),
tau.y = 1,
tau.t = 1,
tau.c = 1,
theta = rep(0,n),
phi = rep(0,n),
yf = rep(0,n))}
covid.sim_normal_normal <- bugs(data_normal, inits_normal_normal, parameters,
model.file = "covid_car_normal_normal.txt",
n.iter = 50000, n.chains = 3, n.burnin = 5000, n.thin = 5,
debug = T)
covid.sim_normal_normal <- bugs(data_normal, inits_normal_normal, parameters,
model.file = "covid_car_normal_normal.txt",
n.iter = 10000, n.chains = 3, n.burnin = 1000, n.thin = 1,
debug = T)
y
